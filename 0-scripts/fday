#!/bin/bash
# Author: Roy Wiseman 2025-01

# ANSI color codes
GREEN='\033[0;32m'
NC='\033[0m' # No Color
BOLD='\033[1m'

# Show usage if -h is passed
if [[ "$1" == "-h" ]]; then
    echo "Usage: $(basename "$0") [days] [directory] [-s] [--exclude pattern] [-h]"
    echo "  days:       Number of days to look back (default: 1, today)."
    echo "  directory:  Target directory (default: current directory)."
    echo "  -sudo | -s  Use sudo for find command."
    echo "  --exclude | -e   Exclude paths matching pattern (can be used multiple times)."
    echo "      Example: --exclude .git --exclude '*.tmp'"
    echo "  -h          Show this help."
    echo "Note: days/directory can be in any order and will be determined dynamically."
    exit 0
fi

# Default values
days=1
dir="."
use_sudo=""
excludes=()

# Function to check if a value is a positive integer
is_number() {
    [[ "$1" =~ ^[0-9]+$ ]]
}

# Parse arguments dynamically
while [[ $# -gt 0 ]]; do
    case "$1" in
        --sudo|-s)
            use_sudo="sudo"
            shift
            ;;
        --exclude|-e)
            if [[ -n "$2" && "$2" != -* ]]; then
                excludes+=("$2")
                shift 2
            else
                echo "Error: --exclude requires a pattern argument"
                exit 1
            fi
            ;;
        *)
            if is_number "$1"; then
                days="$1"
            elif [[ -d "$1" ]]; then
                dir="$1"
            fi
            shift
            ;;
    esac
done

# Convert days to find format (-mtime uses whole days, negative includes today)
mtime=$((days - 1))
start_time=$(date +%s)

# Build exclude conditions for find
exclude_args=""
exclude_display=""
for exclude in "${excludes[@]}"; do
    exclude_args="$exclude_args -not -path '*/$exclude/*' -not -path '*/$exclude'"
    exclude_display="$exclude_display -not -path '*/$exclude/*' -not -path '*/$exclude'"
done

# Define the find command
find_cmd="$use_sudo find \"$dir\" -xdev -type f $exclude_args -mtime -$days -printf '%T@ %p\n' | sort -n"
full_cmd="$use_sudo find \"$dir\" -xdev -type f$exclude_display -mtime -$days -printf '%T@ %p\\n' | sort -n | awk '{ timestamp = \$1; \$1 = \"\"; print strftime(\"%Y-%m-%d %H:%M:%S\", timestamp), substr(\$0,2) }'"

# Display the command with formatting like f does
printf "${BOLD}#${NC} ${GREEN}%s${NC}\n" "$full_cmd"

echo

# Execute the command and capture output
output=$(eval "$find_cmd" | awk '{
    timestamp = $1;
    $1 = "";
    print strftime("%Y-%m-%d %H:%M:%S", timestamp), substr($0,2)
}')

# Count the number of results
file_count=$(echo "$output" | wc -l)

# Calculate start time (midnight X days ago)
cutoff_date=$(date -d "$days days ago" "+%Y-%m-%d 00:00:00")

# Print results
echo "$output"

# Display summary
echo -e "\nFound $file_count files modified since $cutoff_date"
end_time=$(date +%s)
elapsed=$((end_time - start_time))
echo "Execution time: ${elapsed} seconds"
